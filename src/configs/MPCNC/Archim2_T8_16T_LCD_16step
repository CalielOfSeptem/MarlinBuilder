#!/bin/bash

set -e

incdir=$(dirname $0)/..

restore_configs
opt_enable SHOW_CUSTOM_BOOTSCREEN

. $incdir/base-cnc-config
. $incdir/no-dual-endstops

opt_set SERIAL_PORT "-1"
opt_set MOTHERBOARD "BOARD_ARCHIM2"
opt_set DEFAULT_AXIS_STEPS_PER_UNIT "{ 100, 100, 400, 100 }"

opt_set X_DRIVER_TYPE  TMC2130
opt_set Y_DRIVER_TYPE  TMC2130
opt_set Z_DRIVER_TYPE  TMC2130
opt_set X2_DRIVER_TYPE TMC2130
opt_set Y2_DRIVER_TYPE TMC2130
opt_set Z2_DRIVER_TYPE TMC2130
opt_set E0_DRIVER_TYPE TMC2130
opt_set E1_DRIVER_TYPE TMC2130

opt_set SPI_SPEED "SPI_HALF_SPEED"
opt_set MICROSTEP1 "LOW,LOW,LOW"
opt_set MICROSTEP2 "HIGH,LOW,LOW"
opt_set MICROSTEP4 "LOW,HIGH,LOW"
opt_set MICROSTEP8 "HIGH,HIGH,LOW"
opt_set MICROSTEP16 "LOW,LOW,HIGH"
opt_set MICROSTEP32 "HIGH,LOW,HIGH"
opt_set MICROSTEP_MODES "{ 16, 16, 16, 16, 16 }"
opt_set PWM_MOTOR_CURRENT "{ 1200, 1200, 1200 }"
opt_set MAXIMUM_STEPPER_RATE "400000"

opt_enable EEPROM_SETTINGS TMC_USE_SW_SPI

# Why?
opt_set JUNCTION_DEVIATION_MM "0.005"
opt_set MANUAL_FEEDRATE "{30*60, 30*60, 3*60, 60}"
opt_set MM_PER_ARC_SEGMENT ".15"
opt_set X_MAX_ENDSTOP_INVERTING "true"
opt_set Y_MAX_ENDSTOP_INVERTING "true"
opt_set Z_MAX_ENDSTOP_INVERTING "true"
opt_enable BABYSTEP_ALWAYS_AVAILABLE
